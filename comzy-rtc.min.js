class Comzy{constructor(){this.WS_URL="wss://comzy.io:8443",this.configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},this.ws=null,this.pc=null,this.localVideo=null,this.remoteVideo=null,this.localStream=null,this.isOfferer=!1,this.currentRoom=null,this.isInitialized=!1,this.isCallActive=!1,this.config={apiKey:null,userId:null,remoteId:null},this.callbacks={onCallStarted:null,onCallEnded:null,onError:null,onUserJoined:null,onUserLeft:null,onConnectionStateChange:null},this.reconnectDelay=3e3,this.maxReconnectAttempts=5,this.reconnectAttempts=0}init(e,t,s,i={}){if(!e||!t||!s)throw new Error("API key, userId, and remoteId are required");this.config={apiKey:e,userId:t,remoteId:s,...i},this.isInitialized=!0,console.log("Comzy initialized")}async startCall(e,t){if(!this.isInitialized)throw new Error("Library not initialized. Call init() first.");try{if(this.localVideo=document.querySelector(e),this.remoteVideo=document.querySelector(t),!this.localVideo||!this.remoteVideo)throw new Error("Video elements not found.");await this.getUserMedia(),await this.connectToSignalingServer(),this.isCallActive=!0,console.log("Call started"),this.callbacks.onCallStarted&&this.callbacks.onCallStarted()}catch(e){throw this.handleError(e),e}}endCall(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.sendMessage({type:"bye"}),this.pc&&(this.pc.close(),this.pc=null),this.localStream&&(this.localStream.getTracks().forEach((e=>e.stop())),this.localStream=null),this.localVideo&&(this.localVideo.srcObject=null),this.remoteVideo&&(this.remoteVideo.srcObject=null),this.ws&&(this.ws.close(),this.ws=null),this.isCallActive=!1,this.isOfferer=!1,this.currentRoom=null,this.callbacks.onCallEnded&&this.callbacks.onCallEnded(),console.log("Call ended")}on(e,t){this.callbacks.hasOwnProperty(`on${e.charAt(0).toUpperCase()+e.slice(1)}`)&&(this.callbacks[`on${e.charAt(0).toUpperCase()+e.slice(1)}`]=t)}async getUserMedia(){try{this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:{width:{ideal:1280},height:{ideal:720}}}),this.localVideo&&(this.localVideo.srcObject=this.localStream)}catch(e){throw new Error("Camera/microphone access denied or not available")}}connectToSignalingServer(){return new Promise(((e,t)=>{this.ws=new WebSocket(this.WS_URL);const s=setTimeout((()=>{t(new Error("Connection timeout"))}),1e4);this.ws.onopen=()=>{clearTimeout(s),this.reconnectAttempts=0,this.joinRoom(),e()},this.ws.onmessage=e=>{const t=JSON.parse(e.data);this.handleSignalingMessage(t)},this.ws.onclose=()=>{clearTimeout(s),this.isCallActive&&this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,setTimeout((()=>{this.connectToSignalingServer().catch((()=>{}))}),this.reconnectDelay))},this.ws.onerror=e=>{clearTimeout(s),t(e)}}))}joinRoom(){const e={type:"join",apiKey:this.config.apiKey,userId:this.config.userId,remoteId:this.config.remoteId};this.sendMessage(e)}sendMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}handleSignalingMessage(e){switch(e.type){case"created":this.currentRoom=e.room;break;case"joined":this.currentRoom=e.room,this.callbacks.onUserJoined&&this.callbacks.onUserJoined(e);break;case"ready":this.isOfferer=!0,this.startWebRTC(!0);break;case"roomInfo":this.pc||2!==e.userCount||this.isOfferer||this.startWebRTC(!1);break;case"message":this.handleWebRTCMessage(e);break;case"bye":this.handleUserLeft();break;case"error":this.handleError(new Error(e.message))}}async handleWebRTCMessage(e){const t=e.data;try{if(t.sdp){if(await this.pc.setRemoteDescription(new RTCSessionDescription(t.sdp)),"offer"===this.pc.remoteDescription.type){const e=await this.pc.createAnswer();await this.pc.setLocalDescription(e),this.sendWebRTCMessage({sdp:this.pc.localDescription})}}else t.candidate&&await this.pc.addIceCandidate(new RTCIceCandidate(t.candidate))}catch(e){this.handleError(e)}}sendWebRTCMessage(e){const t={type:"message",data:e};this.sendMessage(t)}async startWebRTC(e){if(this.pc=new RTCPeerConnection(this.configuration),this.pc.onicecandidate=e=>{e.candidate&&this.sendWebRTCMessage({candidate:e.candidate})},this.pc.ontrack=e=>{const t=e.streams[0];!this.remoteVideo||this.remoteVideo.srcObject&&this.remoteVideo.srcObject.id===t.id||(this.remoteVideo.srcObject=t)},this.pc.onconnectionstatechange=()=>{this.callbacks.onConnectionStateChange&&this.callbacks.onConnectionStateChange(this.pc.connectionState)},this.localStream&&this.localStream.getTracks().forEach((e=>{this.pc.addTrack(e,this.localStream)})),e)try{const e=await this.pc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});await this.pc.setLocalDescription(e),this.sendWebRTCMessage({sdp:this.pc.localDescription})}catch(e){this.handleError(e)}}handleUserLeft(){this.pc&&(this.pc.close(),this.pc=null),this.remoteVideo&&(this.remoteVideo.srcObject=null),this.isOfferer=!1,this.callbacks.onUserLeft&&this.callbacks.onUserLeft()}handleError(e){this.callbacks.onError&&this.callbacks.onError(e)}toggleVideo(){if(this.localStream){const e=this.localStream.getVideoTracks()[0];if(e)return e.enabled=!e.enabled,e.enabled}return!1}toggleAudio(){if(this.localStream){const e=this.localStream.getAudioTracks()[0];if(e)return e.enabled=!e.enabled,e.enabled}return!1}getCallStatus(){return{isActive:this.isCallActive,connectionState:this.pc?this.pc.connectionState:"closed",iceConnectionState:this.pc?this.pc.iceConnectionState:"closed"}}}"undefined"!=typeof window&&(window.Comzy=Comzy),"undefined"!=typeof module&&module.exports&&(module.exports=Comzy);